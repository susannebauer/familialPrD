---
title: "Plots_DEGanalysis (salmon)"
author: "Susanne Bauer"
date: "22/03/2021"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  directory: "~/Documents/DataAnalysis_Ribotag/Prion_project/"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Documents/DataAnalysis_Ribotag/Prion_project/")
knitr::opts_chunk$set(echo = TRUE)
```


```{r load packages}
library(tidyr)
library(ggplot2)
library(ggrepel)
library(ggforce)
library(dplyr)
library(plotly)
library(reshape2)
library(UpSetR)
library(kableExtra)
library(patchwork)
library(tximport)

dir <- params$directory
date <- Sys.Date()

group_color_scheme <- c(FFI = "#B74D67", CJD = "#1D599C", Control = "#FEAF92")
```

#Load DESeq2 results for all FFI and CJD cell types
```{r, concatenate DESeq2 genestat results}
#set path to results folder with DESeq2 output
path_FFI <-  paste0(dir, "intermediate_files/FFI/")
path_CJD <- paste0(dir, "intermediate_files/CJD/")

compile_genestats <- function(path){
  DEseq_list <- list.files(path, pattern = glob2rx("DESeq2*.csv"), full.names = T)
  
#extract TPM values and gene id from samples, sort by gene id and sum duplicates. Save TPM values with id in list
  genestats <- list()
  for (i in 1:length(DEseq_list)){
    name <- regmatches(DEseq_list[i], regexec('DESeq2_(.*?)\\.csv', DEseq_list[i]))[[1]][2]
    name <- strsplit(name, split = "_")
    Disease <- name[[1]][1]
    Celltype <- name [[1]][2]
    
    stat <- read.delim(DEseq_list[i], header=T, stringsAsFactors = F, sep = ",")
    stat$Celltype <- Celltype
    stat$Disease <- Disease
    genestats[[paste(Celltype)]] <- stat
    i <- i+1
  }
  
  all_stats <- bind_rows(genestats, .id = "Celltype")
  all_stats <- all_stats[complete.cases(all_stats),]
  all_stats <- all_stats %>%
    dplyr::select(Disease, Celltype, X, symbol, entrez, pvalue, padj, shrunkenLFC)%>%
    dplyr::rename(Ensembl = X, sLFC = shrunkenLFC, Entrez = entrez)
  return(all_stats)
}

CJD_genestats <- compile_genestats(path = path_CJD)
FFI_genestats <- compile_genestats(path = path_FFI)

all_genestats <- rbind(CJD_genestats, FFI_genestats)

#save compiled files
write.csv(CJD_genestats, file = paste0(dir, "/result_files/DEseq/CJD_DESeq_res_all",date,".csv"))
write.csv(FFI_genestats, file = paste0(dir, "/result_files/DESeq/FFI_DESeq_res_all",date,".csv"))
```

#Select only significant (FDR ≤ 0.05) DEGs
```{r format input data scatterplots}
#subset to keep only sig. DEGs
CJD_DEGs <- CJD_genestats %>% filter(padj < 0.05)
FFI_DEGs <- FFI_genestats %>% filter(padj < 0.05)

write.csv(CJD_DEGs, file = paste0(dir, "/result_files/DESeq/CJD_DEGs",date,".csv"))
write.csv(FFI_DEGs, file = paste0(dir, "/result_files/DESeq/FFI_DEGs",date,".csv"))

#set Celltypes as factors to determine order on plot
set_celltype_order <- function(data){
  data$Celltype <- factor(data$Celltype, 
                          levels = c("GadCer","PV","SST","VglutCer","GadCb", "VglutCb"))
  return(data)
}


#count number of DEGs by cell type, set count 0 if no DEGs detected in cell type
count_DEG <- function(data){
  data <- data %>% add_count(Celltype)
  data$n2 <- ifelse(is.na(data$sLFC), 0, data$n)
  return(data)
}

#create input data
FFI <- set_celltype_order(FFI_DEGs)
FFI <- count_DEG(FFI)

CJD <- set_celltype_order(CJD_DEGs)
CJD <- count_DEG(CJD)
```

#Jitter plots DEGs for all cell types by disease 
```{r scatter+violin plot showing DEGs by celltype}

#basic plot format
jitter_plot <- function(data){

  counts <- data %>%
    group_by(Celltype) %>%
    summarise(n = n())%>%
    filter(n >= 20)
  high_deg <- filter(data, Celltype %in% counts$Celltype)
  
  pos <- position_jitter(width = 0.2, height = 0.2)
  
  ggplot(data, mapping = aes(x = Celltype, y = sLFC, fill = padj, label = n2))+
      geom_jitter(position = pos, alpha = 0.5, size = 3, shape = 21, show.legend = T)+
      geom_text(data, mapping = aes(x = Celltype, y = n2), color = "grey52", y = Inf, vjust = 1, size = 8)+
      scale_fill_gradient2(mid = "#542788", high = "#FFC300")+
      geom_violin(high_deg, mapping = aes(x = Celltype, y = sLFC), alpha = 0.2, width = 1)+
      scale_x_discrete(labels = c(GadCer = "Gad2\nCerebrum", PV = "PV\nCerebrum", SST = "SST\nCerebrum", VglutCer = "vGluT2\nCerebrum", GadCb = "Gad2\nCerebellum", VglutCb = "vGluT2\nCerebellum"))+
      labs(fill = "FDR")+
      theme_bw() +
      theme(axis.title.x = element_blank(),
            axis.text.x = element_text(size = 16),
            axis.text.y = element_text(size = 14),
            legend.text = element_text(size = 14),
            panel.grid.major.y = element_line(colour = "grey95"),
            panel.grid.minor.y = element_blank(),
            panel.grid.major.x = element_blank(),
            panel.border = element_blank(),
            plot.subtitle = element_text(margin = margin(0,0,20,0)),
            plot.title.position = "panel",
            title = element_text(size = 20))
}

#CJD DEGs
set.seed(123)
CJD_jitter <- jitter_plot(CJD)
p1 <- CJD_jitter +
  ylim(-30,30)+
  labs(y = "log2 Fold Change",
       title = "Creutzfeldt-Jakob Disease (CJD)",
       subtitle = "Differentially expressed genes by cell type, FDR ≤ 0.05")
  #theme(legend.position = "none")
p1

#FFI DEGs
set.seed(123)
FFI_jitter <- jitter_plot(FFI)
p2 <- FFI_jitter +
  ylim(-30,30)+
  labs(y = "log2 Fold Change",
       title = "Fatal Familial Insomnia (FFI)",
       subtitle = "Differentially expressed genes by cell type, FDR ≤ 0.05")
p2

ggsave(plot = p1, file = paste0(dir, "figures/DESeq2/CJD_DEGs_violin",date,".png"), dpi = 300, units = "cm", width = 25, height = 15)

ggsave(plot = p2, file = paste0(dir, "figures/DESeq2/FFI_DEGs_violin",date,".png"), dpi = 300, units = "cm", width = 25, height = 15)


#Jitter plots with zoom_in -> outliers not removed from data
CJD_zoom <- p1 
CJD_zoom$layers[[3]] <- NULL #remove violin plots from zoom-in
CJD_zoom <- CJD_zoom + coord_cartesian(ylim = c(-13,10))
ggsave(plot = CJD_zoom, file = paste0(dir, "figures/DESeq2/CJD_DEGs_violin_zoom",date,".png"), dpi = 300, units = "cm", width = 25, height = 15)
CJD_zoom

FFI_zoom <- p2 
FFI_zoom$layers[[3]] <- NULL
FFI_zoom <- FFI_zoom + coord_cartesian(ylim = c(-13,10))
ggsave(plot = FFI_zoom, file = paste0(dir, "figures/DESeq2/FFI_DEGs_violin_zoom",date,".png"), dpi = 300, units = "cm", width = 25, height = 15)
```

#Zoom-in jitter plot for SST neurons, highlighting ribosomal proteins
```{r}
#zoom_in SST
set.seed(123)
jitter_zoom <- function(data){
  rpp <- data %>%
    filter(grepl("Rp", symbol))%>%
    pull(symbol)
  
  data <- data %>%
    filter(Celltype == "SST")%>%
    mutate("RP" = case_when(symbol %in% rpp ~T,
                            T ~F))
  
  pos <- position_jitter(width = 0.2, height = 0.2)
  
  ggplot(data, mapping = aes(x = Celltype, y = sLFC, fill = padj, label = n2))+
      #geom_violin(alpha = 0.1, width = 1)+
      geom_point(aes(alpha = RP), position = pos, size = 2.5, shape = 21, show.legend = F)+
      #geom_text(data, mapping = aes(x = Celltype, y = n2), color = "grey52", y = -27, size = 8)+
      #geom_text_repel(aes(label = ifelse(symbol %in% rpp, symbol, "")), position = pos, max.overlaps = Inf, min.segment.length = 0)+
      scale_fill_gradient2(mid = "#542788", high = "#FFC300")+
      #guides(alpha = guide_legend(override.aes = list(shape = 21, size = 2.5)))+
      ylim(-2,2)+
      theme_bw() +
      theme(axis.title.x = element_blank(),
            axis.text.x = element_text(size = 16),
            axis.text.y = element_text(size = 14),
            legend.text = element_text(size = 14),
            panel.grid.major.y = element_line(colour = "grey95"),
            panel.grid.minor.y = element_blank(),
            panel.grid.major.x = element_blank(),
            panel.border = element_blank(),
            plot.subtitle = element_text(margin = margin(0,0,20,0)),
            plot.title.position = "panel",
            title = element_text(size = 20))+
    labs(
         y = "log2 Fold Change",
         x = "",
         fill = "FDR")
}
FFI_rpp <- jitter_zoom(FFI) + labs(subtitle = "FFI", y = "")
FFI_rpp
ggsave(file = paste0(dir, "figures/DESeq2/FFI_violin_zoom_RPs",date,".png"), dpi = 300, units = "cm", width = 10, height = 10)


CJD_rpp <- jitter_zoom(CJD)  + labs(subtitle = "CJD") + theme(legend.position = "none")
CJD_rpp
ggsave(file = paste0(dir, "figures/DESeq2/CJD_violin_zoom_RPs",date,".png"), dpi = 300, units = "cm", width = 10, height = 10)

CJD_rpp + FFI_rpp

ggsave(file = paste0(dir, "figures/DESeq2/both_violin_zoom_RPs",date,".png"), dpi = 300, units = "cm", width = 20, height = 10)
```

#Barplots with up/downregulated genes by disease and cell type
```{r barplot showing direction of DEGs}
#barplot showing number of up and down regulated genes by cell type
Prion <- rbind(FFI, CJD)

get_shared_DEG <- function(df){
  ct <- levels(Prion$Celltype)
  l <- list()

  for (i in 1:length(ct)) {
    z <- ct[i]
    p <- df[complete.cases(df),]
    p <- p %>% filter(Celltype == z)
    q <- as.vector(p %>% 
      filter(Disease == "CJD") %>%
      dplyr::select(symbol)) %>%
      pull(symbol)
    r <- as.vector(p %>% 
      filter(Disease == "FFI") %>%
      dplyr::select(symbol)) %>%
      pull(symbol)
    s <- intersect(q,r)
    
    t <- Prion %>%
    filter(Celltype == z)%>%
    mutate(shared_DEG = case_when(
      symbol %in% s ~ "shared",
      TRUE ~ "unique"))
  
  l[[paste(z)]] <- t
      
  i <- i+1
  }
  
  return(l)
}

p <- get_shared_DEG(Prion)
Prion <- do.call(rbind, p)

p_Prion <- Prion %>%
  mutate(Direction = sign(sLFC)) %>%
  group_by(Celltype, Disease)  %>%
  dplyr::count(Direction) %>%
  mutate(ndir = n*Direction) %>%
  mutate(Direction = ifelse(Direction == 1, "up", "down")) 
  
barplot_DEG <- ggplot(p_Prion, aes(x = Celltype, y = ndir, fill = Direction, label = n))+  
  geom_col(colour = "black",  
           position = position_stack(), 
           width = 0.75)+
  geom_hline(yintercept = 0)+
  geom_text(aes(x = Celltype, y = ndir+65*sign(ndir), color = Direction), size = 4)+
  scale_fill_manual(values = c("#006699","#990000", "#7FB2CC", "#CC7F7F"))+
  scale_color_manual(values = c("#006699","#990000", "#7FB2CC", "#CC7F7F"))+
  scale_x_discrete(labels = c(GadCer = "Gad2\nCerebrum", PV = "PV\nCerebrum", SST = "SST\nCerebrum", VglutCer = "vGluT2\nCerebrum", GadCb = "Gad2\nCerebellum", VglutCb = "vGluT2\nCerebellum"))+
  ylim(-470,450)+
  theme_bw() + 
  theme(
    plot.title.position = "plot",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major = element_blank()
  ) +
  labs(title = "Number of differentially translated genes",
       subtitle = "FDR ≤ 0.05",
       y = "",
       x = "")+
  facet_grid(~Disease)
barplot_DEG + coord_flip()

ggsave(file = paste0(dir, "figures/DESeq2/DEGs_barplot",date,".png"), dpi = 300, units = "cm", width = 35, height = 15)
```

#Venn diagram shared DEGs between FFI and CJD for SST neurons
```{r}
mat <- Prion %>%
  mutate(Direction = sign(sLFC)) %>%
  group_by(Celltype, Disease, shared_DEG)  %>%
  dplyr::count(Direction) %>%
  mutate(Dir = case_when(Direction > 0 ~ "up",
                         Direction < 0 ~ "down"))%>%
  filter(!(Disease == "CJD" & shared_DEG == "shared"))%>%
  mutate(Disease = case_when(shared_DEG == "shared" ~ "shared",
                             TRUE ~ Disease))%>%
  mutate(n2 = n*Direction)

cts <- c("GadCer", "SST", "PV", "VglutCer","GadCb", "VglutCb")
names(cts) <- c("Gad2 Cerebrum", "SST", "PV", "vGluT2 Cerebrum", "Gad2 Cerebellum", "vGluT2 Cerebellum")
ct <- cts[2]

mat_ct <- mat %>%
  filter(Celltype == ct) %>%
  mutate(label = paste(Disease, Dir)) %>%
  arrange(Disease)

library(eulerr)
set.seed(13)
w <- as.numeric(mat_ct %>% pull(n))
n <- c("CJD down", "CJD up", "FFI down", "FFI up", "CJD down&FFI down")#, "CJD up&FFI up")
names(w) <- n
d <- euler(w, shape = "ellipse")

venn <- plot(d, 
     quantities = list(cex = 1.5),
     labels = list(font = 4, cex = 1.5, vjust = 4, hjust = 2),
     fill = c("#B3DBEF", "#F3B1B1",  "#7FB2CC","#CC7F7F"))
venn
ggsave(filename = paste0(dir,"figures/DESeq2/Venn_",ct,"_",date,".png"), plot = venn, dpi = 300, units = "cm", width = 25, height = 11)

```

#Barplot of number of up/downregulated and shared DEGs between diseases
```{r}
mat <- Prion %>%
  mutate(Direction = sign(sLFC)) %>%
  group_by(Celltype, Disease, shared_DEG)  %>%
  dplyr::count(Direction) %>%
  mutate(Dir = case_when(Direction > 0 ~ "up",
                         Direction < 0 ~ "down"))%>%
  mutate(n2 = n*Direction)%>%
  mutate(shared = paste(shared_DEG, Disease))%>%
  mutate(shared = case_when(shared == "shared FFI" ~"shared",
                            shared == "shared CJD" ~"shared",
                            TRUE ~shared))
mat$Celltype <- factor(mat$Celltype, labels = c(GadCer = "Gad2\nCerebrum", PV = "PV\nCerebrum", SST = "SST\nCerebrum", VglutCer = "vGluT2\nCerebrum", GadCb = "Gad2\nCerebellum", VglutCb = "vGluT2\nCerebellum"))

mat_nSST <- mat %>% filter(Celltype != "SST\nCerebrum")
mat_SST <- mat %>% filter(Celltype == "SST\nCerebrum")

make_DEG_barplot <- function(data){
  plot <- ggplot(data, aes(x = Disease, y = n2, fill = shared, label = n))+
  geom_col(position = position_stack(reverse = T))+
  geom_hline(yintercept = 0, color = "white")+
  scale_fill_manual(values = c("#FEAF92", "#1D599C", "#B74D67"))+
  scale_y_continuous(labels = abs)+
  theme_minimal()+
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 14),
    plot.title = element_text(size = 20),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )+
    labs(y = "",
       x = "",
       fill = "FDR ≤ 0.05")+
  facet_grid(~Celltype,  drop = T, scales = "free_y", space = "free_y", shrink = F,  margin = T)+
  theme(strip.text.x = element_text(size = 12))
  
  return(plot)
}

bar_nSST <- make_DEG_barplot(mat_nSST)
bar_nSST
ggsave(filename = paste0(dir, "figures/DESeq2/bar_sharedDEG_nSST.png"), units = "cm", width = 18, height = 10)

bar_SST <- make_DEG_barplot(mat_SST)
bar_SST + theme(legend.position = "none", plot.title = element_blank())
ggsave(filename = paste0(dir, "figures/DESeq2/bar_sharedDEG_SST.png"), units = "cm", width = 4, height = 10)
  
```

#LFC correlation of all genes between diseases by cell type
```{r}
df_lfc_corr <- function(ct) {
  cjd <- filter(CJD_genestats, Celltype == ct)
  ffi <- filter(FFI_genestats, Celltype == ct)
  
  #make df with lfc and fdr values for genes from both diseases
  b <- intersect(cjd$symbol, ffi$symbol)
  cjd <- cjd %>% 
    filter(symbol %in% b) %>%
    dplyr::select(symbol, lfc_CJD = sLFC, fdr_CJD = padj)
  ffi <- ffi %>%
    filter(symbol %in% b) %>%
    dplyr::select(symbol, lfc_FFI = sLFC, fdr_FFI = padj)
  lfc_corr <-merge(cjd, ffi, by = "symbol")
  
  #add column stating if gene is differentially expressed (fdr < 0.05) in one or both diseases
  lfc_corr <- lfc_corr %>%
    mutate(disease = case_when(fdr_CJD <= 0.05 & fdr_FFI <= 0.05 ~ "both",
                             fdr_CJD <= 0.05 & fdr_FFI > 0.05 ~ "CJD",
                             fdr_CJD > 0.05 & fdr_FFI <= 0.05 ~ "FFI",
                             TRUE ~ "neither"))
  lfc_corr <- lfc_corr %>%
    mutate(delta = abs(lfc_CJD - lfc_FFI))

  cols <- c(FFI = "#B74D67", CJD = "#1D599C", both = "#FEAF92", neither = "#C6C4C4")
  p1 <- ggplot(lfc_corr, aes(x = lfc_FFI, y = lfc_CJD, color = disease))+
    annotate(geom = "rect", xmin = 0, xmax = -Inf, ymin = 0, ymax = Inf, alpha = 0.1, color = "#E5E5E5")+
    annotate(geom = "rect", xmin = 0, xmax = Inf, ymin = 0, ymax = -Inf, alpha = 0.1, color = "#E5E5E5")+
    geom_point(alpha = 0.5, size = 2)+
    geom_hline(yintercept = 0, color = "grey50")+
    geom_vline(xintercept = 0, color = "grey50")+
    #geom_text_repel(label = ifelse(lfc_corr$delta > 0.5, lfc_corr$symbol, ""),show.legend = F, max.overlaps = 40)+
    scale_color_manual(values = cols)+
    guides(color = guide_legend(override.aes = list(size = 3)))+
    coord_fixed(ratio = 1)+
    theme_bw()+
    theme(panel.grid.minor = element_blank(),
          plot.title.position = "plot"
    )+
    labs(title = names(ct),
         x = "FFI, log2 fold change",
         y = "CJD, log2 fold change ",
         color = "DEGs, FRD ≤ 0.05")

  p2 <- p1 +
    #annotate(geom = "label", x = -Inf, y = Inf, label = "up in CJD, down in FFI", color = "grey72")+
    #annotate(geom = "label", x = Inf, y = Inf, label = "up in both diseases", color = "grey72")+
    #annotate(geom = "label", x = Inf, y = -Inf, label = "down in CJD, up in FFI", color = "grey72")+
    #annotate(geom = "label", x = -Inf, y = -Inf, label = "down in both diseases", color = "grey72")+
    annotate(geom = "rect", xmin = -1.5, xmax = 1.5, ymin = -1.5, ymax = 1.5, alpha = 0.1, color = "black", fill = NA)+
    theme(legend.position = "none")
  
   ggsave(filename = paste0(dir, "figures/DESeq2/LFC_corr_", ct, ".png"), height = 12, width = 15, units = "cm", plot = p2)
  
  p3 <- p1+
    scale_y_continuous(limits = c(-1.5,1.5))+
    scale_x_continuous(limits = c(-1.5,1.5))
  #annotate(geom = "label", x = -0.8, y = 1.4, label = "up in CJD, down in FFI", color = "grey72")+
  #annotate(geom = "label", x = 0.8, y = 1.4, label = "up in both diseases", color = "grey72")+
  #annotate(geom = "label", x = 0.8, y = -1.4, label = "down in CJD, up in FFI", color = "grey72")+
  #annotate(geom = "label", x = -0.8, y = -1.4, label = "down in both diseases", color = "grey72")
  
  ggsave(filename = paste0(dir, "figures/DESeq2/LFC_corr_detail_", ct, ".png"), height = 12, width = 15, units = "cm", plot = p3)
  
  p4 <- (p2 + p3)
  
  return(p4)

}

type <- c("GadCer", "SST", "PV", "VglutCer", "GadCb", "VglutCb")
names(type) <- c("Gad2 Cerebrum", "SST Cerebrum", "PV Cerebrum", "vGlut2 Cerebrum", "Gad2 Cerebellum", "vGlut2 Cerebellum")

df_lfc_corr(type[2])

```

#Upset plots of shared DEGs between cell types for each disease
```{r Upset plots showing shared genes}
#Upset plot showing number of shared genes between cell types and diseases
get_upset_input_disease <- function(df){
  require(dplyr)
    
  mat <- df[complete.cases(df),] #remove any NAs as they would be counted as shared genes
  mat <- dplyr::select(mat, "Celltype", "symbol") 
  mat <- split(mat, f = mat$Celltype) #splits df by cell type, return list of lists by cell type
  mat <- list(lapply(mat, "[",, "symbol")) #selects list with gene names from each cell type list
  mat <- mat[[1]]
  return(mat)
}

upset_FFI <- get_upset_input_disease(FFI)
upset_CJD <- get_upset_input_disease(CJD)

#make upset plot by celltype
plot_FFI <- upset(fromList(upset_FFI), 
                   nsets = 6, 
                   point.size = 5, 
                   line.size = 2, 
                   text.scale = c(3, 2, 3, 2, 3, 3),
                   mb.ratio = c(0.5, 0.5),
                   sets.x.label = "DEGs (FFI)")
plot_FFI
png(filename = paste0(dir, "figures/DESeq2/upset_FFI",date,".png"), height = 15, width = 25, units = "cm", res = 300)
plot_FFI
dev.off()

#while (!is.null(dev.list()))  dev.off()

plot_CJD <- upset(fromList(upset_CJD), 
                   nsets = 6, 
                   point.size = 5, 
                   line.size = 2, 
                   text.scale = c(3, 2, 3, 2, 3, 3),
                   mb.ratio = c(0.5, 0.5),
                   sets.x.label = "DEGs (CJD)"
                   ) 
png(filename = paste0(dir, "figures/DESeq2/upset_CJD",date,".png"), height = 15, width = 20, units = "cm", res = 300)
plot_CJD
dev.off()
plot_CJD
```

#Extract name of shared genes between cell types for each disease
```{r}
#function extracts list of intersection members from Upset plot. Unlike plot, which doesn't allow duplicates, it gives all members of the intersection. Uses same input list as "upset" function (before "fromList" transformation)

get_intersect_members <- function(c){
  
  #makes list with all possible combinations of elements in input list -> all possible cell type intersections
 
  combos <- Reduce(c,lapply(2:length(c), 
            function(x) combn(1:length(c),x,simplify=FALSE) ))

  #get intersecting elements from all possible vector combos (here: shared genes between cell types)
  intersect <- lapply(combos, function(x) Reduce(intersect,c[x]) )

  #make list names readable by replacing number with label specifying compared cell type
  levels <- c(1:6)
  labels <- data.frame(lapply(combos, "[", 1:6))
  labs <- c(names(c))
  for (i in 1:length(levels)){
    labels[labels == i] <- labs[i]
    i <- i+1
  }
  
  #combines cell types in intersection into single string to use as name
  new_labels <- list()
  for (i in 1:length(labels)){
    v <- labels[,i][!is.na(labels[,i])]
    v <- toString(v)
    new_labels <- append(new_labels, v)
  }
  names(intersect) <- lapply(new_labels, "[", 1)
  return(intersect)
}

CJD_intersect <- get_intersect_members(upset_CJD)
FFI_intersect <- get_intersect_members(upset_FFI)

#transforms list with intersections into data frame
intersect_table <- function(input){
  max_len <- max(lengths(input)) #get length of longest intersection
  df <- data.frame(t(do.call(cbind.data.frame, c(lapply(input, function(x) 
               c(x, rep("", max_len - length(x)))), stringsAsFactors = FALSE)))) #combine list elements in dataframe with length max_len
  df <- df %>% unite(Shared_genes, everything(), sep = "/ ", remove = T, na.rm = T) #collapse all gene names into one column, separated by ","
  df$count <- as.vector(lengths(input)) #add column with count of genes in intersection
  df <- df[df$count != 0,] #remove empty intersections
  #create output table 
  table <- kable(df, format = "html", row.names = T) %>%
  kable_styling(full_width = T) %>%
   column_spec(column = 1, bold = T)
  
  return(table)
}

FFI_table <- intersect_table(FFI_intersect)
FFI_table

CJD_table <- intersect_table(CJD_intersect)
CJD_table
```

#Get the shared DEGs between diseases (FFI vs. CJD) for each cell type
```{r}
prion <- rbind(FFI, CJD)
prion <- prion %>% unite(Celltype, Disease, Celltype, sep = "_")

#get shared genes between diseases for each cell type
prion_upset <- get_upset_input_disease(prion)
GadCer <- intersect(prion_upset$CJD_GadCer, prion_upset$FFI_GadCer)
SST <- intersect(prion_upset$CJD_SST, prion_upset$FFI_SST)
PV <- intersect(prion_upset$CJD_PV, prion_upset$FFI_PV)
VglutCer <- intersect(prion_upset$CJD_VglutCer, prion_upset$FFI_VglutCer)
GadCb <- intersect(prion_upset$CJD_GadCb, prion_upset$FFI_GadCb)
VglutCb <- intersect(prion_upset$CJD_VglutCb, prion_upset$FFI_VglutCb)


n <- c(length(GadCer), length(SST), length(PV), length(VglutCer), length(GadCb), length(VglutCb))
Celltype <- c("Int_GadCer", "Int_SST", "Int_PV","Int_VglutCer", "Int_GadCb","Int_VglutCb")
int <- data.frame(Celltype, n)


pr_int <- prion %>%
  group_by(Celltype) %>%
  count
pr_int <- rbind(pr_int, int)
pr_int$Disease <- gsub(pattern = "_.*$", replacement = "", pr_int$Celltype)
pr_int$Celltype <- gsub(pattern = "^.*_", replacement = "", pr_int$Celltype)
pr_int <- pivot_wider(pr_int, names_from = Disease, values_from = n)
rownames(pr_int) <- pr_int$Celltype
pr_int$Celltype <- NULL
```

#plot number of DEGs by Chromosome
```{r}
library(biomaRt)
mouse_mart = useMart(biomart = "ensembl", dataset = "mmusculus_gene_ensembl")
df_mm_genes_ensembl <- getBM(attributes = c("ensembl_gene_id", "entrezgene_id", "external_gene_name", "gene_biotype", "chromosome_name", "start_position", "end_position", "strand", "description"), 
             mart = mouse_mart)
detach(package:biomaRt)

ProteinCodingGenes <- df_mm_genes_ensembl %>% filter(gene_biotype == "protein_coding")

idx <- match(all_genestats$Ensembl, ProteinCodingGenes$ensembl_gene_id)
chr_dat <- all_genestats %>%
  mutate(Chromosome = as.factor(ProteinCodingGenes[idx,"chromosome_name"])) %>%
  mutate(Start_Pos = ProteinCodingGenes[idx,"start_position"]) %>%
  filter(padj <= 0.05) %>%
  group_by(Chromosome, Celltype, Disease) %>%
  count() %>%
  mutate(n = ifelse(Disease == "CJD", n*-1, n))
chr_dat$Chromosome <- ordered(chr_dat$Chromosome, levels = c(as.character(seq(1:19)), "X","Y","MT"))
chr_dat$Celltype <- ordered(chr_dat$Celltype, levels = c("GadCer", "PV", "SST", "VglutCer","GadCb","VglutCb"))

chr_p <- ggplot(chr_dat, aes(x = Chromosome, y = n, fill = Disease))+
  geom_col()+
  geom_hline(yintercept = 0, color = "black")+
  scale_y_continuous(labels = abs)+
  scale_fill_manual(values = group_color_scheme)+
  facet_grid(rows = vars(Celltype), scales = "free", margins = F)+
  theme_bw()+
  theme(panel.grid.minor = element_blank())+
  labs(title = "Number of genes by Chromosome",
       y = "Number of differentially expressed genes (FDR ≤ 0.05)",
       fill = "Cell type")
chr_p

ggsave(filename = paste0(dir, "figures/DESeq2/DEGs_by_Chr", date, ".png"), height = 25, width = 15, units = "cm", plot = chr_p)
```

#Create barplot comparing fold changes of individual genes between the diseases
```{r}
set_celltype_order <- function(data){
  data$Celltype <- factor(data$Celltype, 
                          levels = c("GadCer", "PV","SST", "VglutCer","GadCb","VglutCb"))
  return(data)
}

all_genestats <- set_celltype_order(all_genestats)

#Select genes of interest and add asterisk if padj < 0.05
set1 <- c("Arc","Egr1","Egr3", "Camk2a","Junb","Fos","Gsn","Dbn1", "Arc", "Polr2a")
set2 <- c()
set3 <- c("Gm14410", "Gm14322","Gm14418","Gm14412", "Gm4724", "Gm14295", "Gm14305","Gm14296", "Gm14305", "Gm2026", "Gm14325","Gm14326", "Zfp971", "Zfp970")

FC <- all_genestats %>%
  filter(symbol %in% set1) %>%
  mutate(DE = ifelse(padj < 0.05, "*", NA))

ggplot(FC, aes(x = Celltype, y = sLFC))+
  geom_hline(yintercept = 0, color = "grey72")+
  geom_col(aes(fill = Disease), position = position_dodge2(width = 1), width = .6)+
  geom_text(aes(label = DE, hjust = -sign(sLFC)*1.2), position = position_dodge2(width = 0.7))+
  scale_fill_manual(values = c("#0561E7","#9132DC", "#189524"))+
  ylab("log2 Fold Change")+
  xlab("")+
  ylim(-3,3)+
  theme_bw()+
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "grey95"))+
  coord_flip()+
  facet_grid(~symbol)
```

#Compile excel output file of DEGs including TPM values from IPs
```{r}
metadata <- read.csv(paste0(dir,"metadata/prionsamples_meta.csv"), header = T, sep = ",")

#subset which samples to analyze
samples_meta <- metadata %>%
  filter(sample_set != "exclude")

#list salmon output files (quant.sf) for selected samples
files <- file.path(paste0(dir, "raw_data/"),samples_meta$nfcore_id, "quant.sf")

#assign sample id to file names to rename samples based on id in txi output
names(files) <- samples_meta$sample_id  

tx2gene <- read.table(paste0(dir, "metadata/salmon_tx2gene.tsv"))

#read in salmon output files 
txi <- tximport(files, type = "salmon", tx2gene = tx2gene)
#tximport generates several output files. "count" matrix containes raw counts summarized to gene level, which are used for DESeq2 analysis. "abundance" gives tpm values summarized to gene level.

#check that sample order in count and metadata files match
sample_ids <- samples_meta$sample_id
all(colnames(txi$counts) == sample_ids)

all_TPMs <- txi$abundance

#extract and subset ERCC counts
ERCC_idx <- grep(pattern = "ERCC*", rownames(all_TPMs))
ERCC_TPMs <- data.frame(all_TPMs[ERCC_idx,])
all_TPMs <- data.frame(all_TPMs[-ERCC_idx,])

rownames(all_TPMs) <- stringr::str_replace(rownames(all_TPMs), pattern = ".[0-9]+$", replacement = "")

#########CHANGE HERE############
library(stringr)

#Filter IP samples and adjust cell type nomenclature
samples_meta <- samples_meta %>%
  filter(Fraction == "IP")%>%
  filter(sample_set != "exclude") %>%
  mutate(int = interaction(Cell_type, Region))%>%
  mutate(int = case_when(int == "Gad2.Cerebellum" ~ "GadCb",
                         int == "Gad2.Cerebrum" ~ "GadCer",
                         int == "PV.Cerebrum" ~ "PV",
                         int == "SST.Cerebrum" ~ "SST",
                         int == "vGlut2.Cerebellum" ~ "VglutCb",
                         int == "vGlut2.Cerebrum" ~ "VglutCer"))



#get select TPM values for samples  specific cell types
library(xlsx)
ct <- as.character(unique(samples_meta$int))

df_DEG_w_TPM <- list()

for (i in 1:length(ct)) {
  v <- ct[i]
  smpl <- samples_meta %>%
    filter(int == v) %>%
    pull(sample_id)
  
  DEGs <- Prion %>%
    filter(Celltype == v)
  DEG_ens <- unique(DEGs$Ensembl)

  tpm <- all_TPMs %>%
    filter(rownames(.) %in% DEG_ens)%>%
    dplyr::select(all_of(smpl))
 DEG_tpm <- merge(DEGs, tpm, by.x = "Ensembl", by.y = 0)
 
  ##get vector of genes with zero values in Ctrl and disease group
  cjd_s <- samples_meta %>% filter(int == v & Group == "CJD") %>% pull(sample_id)
  ffi_s <- samples_meta %>% filter(int == v & Group == "FFI") %>% pull(sample_id)
  ctrl_s <- samples_meta %>% filter(int == v & Group == "Control") %>% pull(sample_id)
  
  zero_counts <- c()
  for (n in 1:length(DEG_tpm$Ensembl)){
       g <- DEG_tpm[n,] 
       cjd_z <- sum(g[,cjd_s] == 0, na.rm = T) #return logical vector, TRUE if tpm == 0, count TRUEs, if >0 group contains zero sample
       ffi_z <- sum(g[,ffi_s] == 0, na.rm = T)
       ctrl_z <- sum(g[,ctrl_s] == 0, na.rm = T)
       
       zero <- case_when(g$Disease == "CJD" & cjd_z>0 & ctrl_z>0 ~T, #print true if both disease and ctrl group contain zero values
                        g$Disease == "FFI" & ffi_z>0 & ctrl_z>0 ~T,
                        TRUE ~F)
       
       zero_counts[n] <- zero
       n <- n+1
   } 
 DEG_tpm$zero_counts <- zero_counts #include vector with zero_ct in file
 df_DEG_w_TPM[[paste(v)]] <- DEG_tpm %>% select(Disease, Celltype, symbol, sLFC, padj, pvalue, shared_DEG, zero_counts, n, n2)
 
 DEG_tpm <- DEG_tpm %>%
   dplyr::select(-n2, -n)
 
 write.xlsx(DEG_tpm, file = paste0(dir,"result_files/DESeq/", date,"_DEG_with_TPM_zero5.xlsx"), sheetName = v, append = T)
 
 i <- i+1
}

DEG_zero_rm <- do.call("rbind", df_DEG_w_TPM)

```

#Jitter plots with outlier values removed
```{r}
#remove zero count genes from visualization
CJD_cleaned <- DEG_zero_rm %>% filter(zero_counts == FALSE & Disease == "CJD")
FFI_cleaned <- DEG_zero_rm %>% filter(zero_counts == FALSE & Disease == "FFI")


#CJD DEGs
set.seed(123)
jitter_zrm_plot <- function(data){

  counts <- data %>%
    group_by(Celltype) %>%
    summarise(n = n())%>%
    filter(n >= 20)
  high_deg <- filter(data, Celltype %in% counts$Celltype)
  
  pos <- position_jitter(width = 0.1, height = 0.2)
  
  ggplot(data, mapping = aes(x = Celltype, y = sLFC, fill = padj, label = n2))+
      geom_jitter(position = pos, alpha = 0.3, size = 3, shape = 21)+
      #geom_text(data, mapping = aes(x = Celltype, y = n2), color = "grey52", y = -11, size = 8)+
      scale_fill_gradient2(mid = "#542788", high = "#FFC300")+
      #geom_violin(high_deg, mapping = aes(x = Celltype, y = sLFC), alpha = 0.2, width = 1)+
      scale_x_discrete(labels = c(GadCer = "Gad2\nCerebrum", PV = "PV\nCerebrum", SST = "SST\nCerebrum", VglutCer = "vGluT2\nCerebrum", GadCb = "Gad2\nCerebellum", VglutCb = "vGluT2\nCerebellum"))+
      labs(fill = "FDR")+
      theme_bw()+
      theme(axis.title.x = element_blank(),
            axis.text.x = element_text(size = 16),
            axis.text.y = element_text(size = 14),
            legend.text = element_text(size = 14),
            panel.grid.major.y = element_line(colour = "grey95"),
            panel.grid.minor.y = element_blank(),
            panel.grid.major.x = element_blank(),
            panel.border = element_blank(),
            plot.subtitle = element_text(margin = margin(0,0,20,0)),
            plot.title.position = "panel",
            title = element_text(size = 20))
}


CJD_zrm <- jitter_zrm_plot(CJD_cleaned)
p1 <- CJD_zrm +
  ylim(-5,5)+
  geom_text(CJD_cleaned, mapping = aes(x = Celltype, y = n2), color = "grey52", y = Inf, vjust = 1, size = 7)+
  labs(y = "log2 Fold Change",
       title = "Creutzfeldt-Jakob Disease (CJD)",
       subtitle = "Differentially expressed genes by cell type, FDR ≤ 0.05")
p1

#FFI DEGs
set.seed(123)
FFI_zrm <- jitter_zrm_plot(FFI_cleaned)
p2 <- FFI_zrm +
  geom_text(FFI_cleaned, mapping = aes(x = Celltype, y = n2), color = "grey52", y = Inf, vjust = 1, size = 7)+
  labs(y = "log2 Fold Change",
       title = "Fatal Familial Insomnia (FFI)",
       subtitle = "Differentially expressed genes by cell type, FDR ≤ 0.05")
p2

p1
ggsave(file = paste0(dir, "figures/DESeq2/CJD_DEGs_zero_rm",date,".png"), dpi = 300, units = "cm", width = 25, height = 15)

p2
ggsave(file = paste0(dir, "figures/DESeq2/FFI_DEGs_zero_rm",date,".png"), dpi = 300, units = "cm", width = 25, height = 15)


```

